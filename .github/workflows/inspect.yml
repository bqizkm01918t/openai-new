# .github/workflows/inspect.yml
name: ğŸ” Inspect Runner Environment

# æ‰‹åŠ¨è§¦å‘ï¼Œå¹¶æä¾›ä¸€ä¸ªé€‰é¡¹æ¥æ§åˆ¶æ˜¯å¦æ‰“ç 
on:
  workflow_dispatch:
    inputs:
      mask_sensitive_data:
        description: 'æ‰“ç æ•æ„Ÿæ•°æ® (IP, TOKEN, KEY ç­‰) ä»¥ä¾¿åˆ†äº«'
        required: true
        type: boolean
        default: true

jobs:
  inspect:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥éª¤ 1: æ£€å‡ºä»£ç ï¼Œè¿™æ˜¯æ ‡å‡†æ“ä½œ
      - name: 1. Checkout Repository
        uses: actions/checkout@v4

      # æ­¥éª¤ 2: æ˜¾ç¤ºç³»ç»Ÿå’Œ Runner ä¿¡æ¯
      - name: 2. System & Runner Info
        run: |
          echo "========== System & Runner Info =========="
          echo "OS: $(uname -a)"
          echo "User: $(whoami)"
          echo "Hostname: $(hostname)"
          echo "Current Directory: $(pwd)"
          echo "Disk Space:"
          df -h
          echo "Memory:"
          free -h
          echo "------------------------------------------"
          # æ ¹æ®è¾“å…¥å†³å®šæ˜¯å¦æ˜¾ç¤ºå…¬ç½‘ IP
          if [ "${{ github.event.inputs.mask_sensitive_data }}" == "true" ]; then
            echo "Public IP: [MASKED for sharing]"
          else
            echo "Public IP: $(curl -s ifconfig.me)"
          fi
          echo "=========================================="

      # æ­¥éª¤ 3: æ˜¾ç¤ºæ‰€æœ‰ç¯å¢ƒå˜é‡
      - name: 3. All Environment Variables
        run: |
          echo "========== All Environment Variables =========="
          # æ ¹æ®è¾“å…¥å†³å®šæ˜¯å¦è¿‡æ»¤æ•æ„Ÿå˜é‡
          if [ "${{ github.event.inputs.mask_sensitive_data }}" == "true" ]; then
            echo "Filtering out variables with sensitive keywords..."
            # ä½¿ç”¨ grep -v æ¥åå‘è¿‡æ»¤æ‰åŒ…å«æ•æ„Ÿè¯çš„è¡Œ
            # -E è¡¨ç¤ºä½¿ç”¨æ‰©å±•æ­£åˆ™è¡¨è¾¾å¼, -i è¡¨ç¤ºå¿½ç•¥å¤§å°å†™
            env | grep -vE -i "(TOKEN|KEY|SECRET|PASSWORD|SIGNATURE)"
          else
            echo "Showing all variables without filtering..."
            env
          fi
          echo "================================================"

      # æ­¥éª¤ 4: æ˜¾ç¤º GitHub Context çš„å®Œæ•´å†…å®¹
      - name: 4. GitHub Context (JSON)
        run: |
          echo "========== GitHub Context =========="
          # ä½¿ç”¨ toJSON å‡½æ•°å°†æ•´ä¸ª github å¯¹è±¡ä»¥æ ¼å¼åŒ–çš„ JSON è¾“å‡º
          # è¿™åŒ…å«äº†è§¦å‘äº‹ä»¶ã€ä»“åº“ä¿¡æ¯ã€actorã€ref ç­‰æ‰€æœ‰ä¸Šä¸‹æ–‡
          echo '${{ toJSON(github) }}'
          echo "===================================="

      # æ­¥éª¤ 5: æ¼”ç¤ºå¦‚ä½•å®‰å…¨åœ°å¤„ç† Secrets
      # è¿™ä¸ªæ­¥éª¤æ—¨åœ¨æ¼”ç¤ºå¦‚ä½•ç¡®è®¤ secret å­˜åœ¨ä¸”å¯ç”¨ï¼Œè€Œä¸æš´éœ²å…¶å€¼
      - name: 5. Handling Secrets (Safe Demo)
        env:
          # ä¸ºäº†æ¼”ç¤ºï¼Œè¯·å…ˆåœ¨ä½ çš„ä»“åº“ Settings > Secrets and variables > Actions
          # ä¸­æ·»åŠ ä¸€ä¸ªåä¸º "MY_SECRET" çš„ repository secret
          MY_SECRET: ${{ secrets.MY_SECRET }}
        run: |
          echo "========== Secrets Handling Demo =========="
          if [[ -z "$MY_SECRET" ]]; then
            echo "MY_SECRET is not set or is empty."
          else
            # æˆ‘ä»¬åªæ˜¾ç¤º secret çš„é•¿åº¦ï¼Œè¯æ˜å®ƒå·²è¢«æˆåŠŸåŠ è½½ï¼Œä½†ç»ä¸æ‰“å°å…¶å†…å®¹
            # å³ä½¿ä½ å°è¯• echo $MY_SECRETï¼ŒGitHub ä¹Ÿä¼šè‡ªåŠ¨å°†å…¶æ‰“ç ä¸º ***
            echo "MY_SECRET is successfully loaded."
            echo "Length of MY_SECRET: $(echo -n "$MY_SECRET" | wc -c) characters."
          fi
          echo "==========================================="
