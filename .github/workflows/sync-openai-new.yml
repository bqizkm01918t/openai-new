# .github/workflows/sync-openai-new.yml
name: ğŸš€ è‡ªåŠ¨åŒæ­¥ calciumion/new-api åˆ° GHCR å¹¶æ›´æ–°æ—¥å¿—

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨ 2 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ä¸Šåˆ 10 ç‚¹ï¼‰è‡ªåŠ¨åŒæ­¥

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å¿…éœ€ï¼šå…è®¸ä¿®æ”¹ README
      packages: write  # å¿…éœ€ï¼šå…è®¸æ¨é€é•œåƒåˆ° GHCR

    steps:
      - name: ğŸ› ï¸ å‡†å¤‡ç¯å¢ƒ
        run: |
          echo "âœ… å¼€å§‹åŒæ­¥æµç¨‹..."
          echo "â° å½“å‰æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          START_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          echo "START_TIME=$START_TIME" >> $GITHUB_ENV

      - name: ğŸ“¥ æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” ç™»å½•åˆ° GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
        id: login
        continue-on-error: false

      - name: ğŸ“¦ æ‹‰å– Docker Hub ä¸Šçš„æœ€æ–°é•œåƒ
        run: |
          echo "ğŸ“¦ æ­£åœ¨æ‹‰å–: calciumion/new-api:latest"
          docker pull calciumion/new-api:latest
          echo "âœ… æ‹‰å–æˆåŠŸï¼"

      - name: ğŸ·ï¸ é‡å‘½åé•œåƒä¸º openai-new
        run: |
          echo "ğŸ”„ é‡å‘½åé•œåƒ: calciumion/new-api -> ghcr.io/bqizkm01918t/openai-new"
          docker tag calciumion/new-api:latest ghcr.io/bqizkm01918t/openai-new:latest
          echo "âœ… é‡å‘½åå®Œæˆï¼"

      - name: ğŸš€ æ¨é€é•œåƒåˆ° GHCR
        run: |
          echo "ğŸ“¤ æ­£åœ¨æ¨é€: ghcr.io/bqizkm01918t/openai-new:latest"
          docker push ghcr.io/bqizkm01918t/openai-new:latest
          echo "âœ… æ¨é€å®Œæˆï¼é•œåƒå·²è¦†ç›–æ›´æ–°ã€‚"

      - name: ğŸ§ª éªŒè¯é•œåƒæ˜¯å¦æ¨é€æˆåŠŸ
        run: |
          echo "ğŸ” éªŒè¯é•œåƒæ˜¯å¦å­˜åœ¨..."
          docker images | grep -E 'bqizkm01918t/openai-new'
          if [ $? -eq 0 ]; then
            echo "âœ… éªŒè¯é€šè¿‡ï¼šé•œåƒå·²å­˜åœ¨æœ¬åœ°ç¼“å­˜ä¸­ã€‚"
          else
            echo "âŒ éªŒè¯å¤±è´¥ï¼šé•œåƒæœªæ‰¾åˆ°ï¼"
            exit 1
          fi

      - name: ğŸ“Š è·å–é•œåƒä¿¡æ¯
        run: |
          echo "ğŸ“Š è·å–é•œåƒè¯¦æƒ…..."
          IMAGE_DIGEST=$(docker inspect calciumion/new-api:latest --format='{{.Id}}' | cut -c1-12)
          echo "SOURCE_IMAGE_DIGEST=$IMAGE_DIGEST" >> $GITHUB_ENV
          echo "âœ… æºé•œåƒçŸ­æ‘˜è¦: $IMAGE_DIGEST"

      - name: ğŸ“ æ›´æ–° README.md æ—¥å¿—
        run: |
          # è¯»å–å½“å‰ README å†…å®¹
          README_FILE="README.md"
          
          # å¦‚æœ README ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
          if [ ! -f "$README_FILE" ]; then
            echo "# ğŸ“¦ OpenAI New é•œåƒåŒæ­¥æ—¥å¿—" > "$README_FILE"
            echo "" >> "$README_FILE"
            echo "æ­¤ä»“åº“ç”¨äºè‡ªåŠ¨åŒæ­¥ \`calciumion/new-api:latest\` åˆ° \`ghcr.io/bqizkm01918t/openai-new:latest\`" >> "$README_FILE"
            echo "" >> "$README_FILE"
          fi
          
          # æ„å»ºæ–°çš„æ—¥å¿—æ¡ç›®
          NEW_LOG_ENTRY="
### ğŸ“… åŒæ­¥æ—¶é—´: ${{ env.START_TIME }}

- **çŠ¶æ€**: âœ… æˆåŠŸ
- **æºé•œåƒ**: \`calciumion/new-api:latest\`
- **ç›®æ ‡é•œåƒ**: \`ghcr.io/bqizkm01918t/openai-new:latest\`
- **æºé•œåƒæ‘˜è¦**: \`${{ env.SOURCE_IMAGE_DIGEST }}...\`
- **æ“ä½œ**: ğŸ”„ è¦†ç›–æ›´æ–° latest æ ‡ç­¾
- **è§¦å‘æ–¹å¼**: ${{ github.event_name == 'schedule' && 'å®šæ—¶ä»»åŠ¡' || 'æ‰‹åŠ¨è§¦å‘' }}

---

"
          
          # åœ¨ README å¼€å¤´æ’å…¥æ–°æ—¥å¿—ï¼ˆä¿æŒæœ€è¿‘ 10 æ¡ï¼‰
          {
            echo "# ğŸ“¦ OpenAI New é•œåƒåŒæ­¥æ—¥å¿—"
            echo ""
            echo "æ­¤ä»“åº“ç”¨äºè‡ªåŠ¨åŒæ­¥ \`calciumion/new-api:latest\` åˆ° \`ghcr.io/bqizkm01918t/openai-new:latest\`"
            echo ""
            echo "## ğŸ“‹ æœ€æ–°åŒæ­¥æ—¥å¿—"
            echo ""
            echo "$NEW_LOG_ENTRY"
            
            # è¯»å–æ—§æ—¥å¿—ï¼ˆè·³è¿‡æ ‡é¢˜éƒ¨åˆ†ï¼‰
            sed -n '/## ğŸ“‹ æœ€æ–°åŒæ­¥æ—¥å¿—/,$p' "$README_FILE" | sed '1d' | head -n 20
          } > "$README_FILE.tmp" && mv "$README_FILE.tmp" "$README_FILE"

      - name: ğŸ“¤ æäº¤ README æ›´æ–°
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          if git diff --staged --quiet; then
            echo "âš ï¸ æœªå‘ç° README å˜æ›´ï¼Œè·³è¿‡æäº¤ã€‚"
          else
            git commit -m "ğŸ“ æ›´æ–°åŒæ­¥æ—¥å¿— - $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "âœ… README å·²æ›´æ–°å¹¶æ¨é€ã€‚"
          fi

      - name: ğŸ“ è¾“å‡ºæœ€ç»ˆé•œåƒåœ°å€
        run: |
          echo "ğŸ‰ åŒæ­¥å®Œæˆï¼"
          echo "ğŸ“ é•œåƒåœ°å€: ghcr.io/bqizkm01918t/openai-new:latest"
          echo "ğŸ“… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
