# .github/workflows/sync-openai-new.yml
name: ğŸš€ è‡ªåŠ¨åŒæ­¥ calciumion/new-api åˆ° GHCR

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨ 2 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ä¸Šåˆ 10 ç‚¹ï¼‰è‡ªåŠ¨åŒæ­¥

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      packages: write  # å¿…éœ€ï¼šå…è®¸æ¨é€é•œåƒåˆ° GHCR
      contents: write  # å¿…éœ€ï¼šå…è®¸æ›´æ–°READMEæ–‡ä»¶

    steps:
      - name: ğŸ› ï¸ å‡†å¤‡ç¯å¢ƒ
        run: |
          echo "âœ… å¼€å§‹åŒæ­¥æµç¨‹..."
          echo "â° å½“å‰æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          
      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ” ç™»å½•åˆ° GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        id: login
        continue-on-error: false

      - name: ğŸ“¦ æ‹‰å– Docker Hub ä¸Šçš„æœ€æ–°é•œåƒ
        run: |
          echo "ğŸ“¦ æ­£åœ¨æ‹‰å–: calciumion/new-api:latest"
          docker pull calciumion/new-api:latest
          echo "âœ… æ‹‰å–æˆåŠŸï¼"
          
      - name: ğŸ·ï¸ è·å–é•œåƒä¿¡æ¯
        id: image-info
        run: |
          # è·å–é•œåƒåˆ›å»ºæ—¶é—´
          IMAGE_CREATED=$(docker inspect calciumion/new-api:latest --format='{{.Created}}')
          # è·å–é•œåƒå¤§å°
          IMAGE_SIZE=$(docker inspect calciumion/new-api:latest --format='{{.Size}}')
          # è½¬æ¢å¤§å°ä¸ºMB
          IMAGE_SIZE_MB=$(echo "scale=2; $IMAGE_SIZE / 1024 / 1024" | bc)
          # è·å–é•œåƒID
          IMAGE_ID=$(docker inspect calciumion/new-api:latest --format='{{.Id}}' | cut -d: -f2 | cut -c1-12)
          
          echo "created=$IMAGE_CREATED" >> $GITHUB_OUTPUT
          echo "size_mb=$IMAGE_SIZE_MB" >> $GITHUB_OUTPUT
          echo "id=$IMAGE_ID" >> $GITHUB_OUTPUT
          
          echo "ğŸ“‹ é•œåƒä¿¡æ¯:"
          echo "  åˆ›å»ºæ—¶é—´: $IMAGE_CREATED"
          echo "  å¤§å°: $IMAGE_SIZE_MB MB"
          echo "  ID: $IMAGE_ID"

      - name: ğŸ·ï¸ é‡å‘½åé•œåƒä¸º openai-new
        run: |
          echo "ğŸ”„ é‡å‘½åé•œåƒ: calciumion/new-api -> ghcr.io/${{ github.repository_owner }}/openai-new"
          docker tag calciumion/new-api:latest ghcr.io/${{ github.repository_owner }}/openai-new:latest
          echo "âœ… é‡å‘½åå®Œæˆï¼"

      - name: ğŸš€ æ¨é€é•œåƒåˆ° GHCR
        run: |
          echo "ğŸ“¤ æ­£åœ¨æ¨é€: ghcr.io/${{ github.repository_owner }}/openai-new:latest"
          docker push ghcr.io/${{ github.repository_owner }}/openai-new:latest
          echo "âœ… æ¨é€å®Œæˆï¼é•œåƒå·²è¦†ç›–æ›´æ–°ã€‚"

      - name: ğŸ§ª éªŒè¯é•œåƒæ˜¯å¦æ¨é€æˆåŠŸ
        run: |
          echo "ğŸ” éªŒè¯é•œåƒæ˜¯å¦å­˜åœ¨..."
          docker images | grep -E '${{ github.repository_owner }}/openai-new'
          if [ $? -eq 0 ]; then
            echo "âœ… éªŒè¯é€šè¿‡ï¼šé•œåƒå·²å­˜åœ¨æœ¬åœ°ç¼“å­˜ä¸­ã€‚"
          else
            echo "âŒ éªŒè¯å¤±è´¥ï¼šé•œåƒæœªæ‰¾åˆ°ï¼"
            exit 1
          fi

      - name: ğŸ“ å‡†å¤‡æ—¥å¿—å†…å®¹
        id: log-content
        run: |
          # ç¡®å®šè§¦å‘æ–¹å¼
          if [ "${{ github.event_name }}" == "schedule" ]; then
            TRIGGER_TYPE="ğŸ¤– è‡ªåŠ¨æ‰§è¡Œ"
            TRIGGER_ICON="ğŸ•"
          else
            TRIGGER_TYPE="ğŸ‘¤ æ‰‹åŠ¨è§¦å‘"
            TRIGGER_ICON="ğŸ”˜"
          fi
          
          # æ ¼å¼åŒ–æ—¶é—´
          CURRENT_TIME=$(date '+%Y-%m-%d %H:%M:%S %Z')
          IMAGE_CREATED=$(date -d '${{ steps.image-info.outputs.created }}' '+%Y-%m-%d %H:%M:%S %Z')
          
          # åˆ›å»ºæ—¥å¿—æ¡ç›®
          LOG_ENTRY="| $CURRENT_TIME | $TRIGGER_TYPE | ${{ steps.image-info.outputs.id }} | ${{ steps.image-info.outputs.size_mb }} MB | $IMAGE_CREATED | [æŸ¥çœ‹æ—¥å¿—](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |"
          
          # ä¿å­˜åˆ°è¾“å‡º
          echo "entry=$LOG_ENTRY" >> $GITHUB_OUTPUT
          echo "trigger_type=$TRIGGER_TYPE" >> $GITHUB_OUTPUT
          echo "trigger_icon=$TRIGGER_ICON" >> $GITHUB_OUTPUT
          
          echo "ğŸ“ æ—¥å¿—æ¡ç›®å·²å‡†å¤‡:"
          echo "$LOG_ENTRY"

      - name: ğŸ“„ æ›´æ–°READMEæ–‡ä»¶
        run: |
          # è·å–å½“å‰READMEå†…å®¹
          README_CONTENT=$(cat README.md)
          
          # æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ—¥å¿—è¡¨æ ¼
          if [[ "$README_CONTENT" == *"## ğŸ“‹ åŒæ­¥æ—¥å¿—"* ]]; then
            echo "ğŸ“„ READMEä¸­å·²å­˜åœ¨æ—¥å¿—è¡¨æ ¼ï¼Œå°†æ›´æ–°..."
            
            # æå–è¡¨æ ¼ä¹‹å‰çš„å†…å®¹
            TABLE_START=$(echo "$README_CONTENT" | grep -n "## ğŸ“‹ åŒæ­¥æ—¥å¿—" | cut -d: -f1)
            BEFORE_TABLE=$(echo "$README_CONTENT" | head -n $((TABLE_START-1)))
            
            # æå–è¡¨æ ¼ä¹‹åçš„å†…å®¹
            TABLE_END=$(echo "$README_CONTENT" | grep -n "## " | grep -A1 -n "## ğŸ“‹ åŒæ­¥æ—¥å¿—" | tail -1 | cut -d: -f1)
            if [ -z "$TABLE_END" ]; then
              AFTER_TABLE=""
            else
              AFTER_TABLE=$(echo "$README_CONTENT" | tail -n +$TABLE_END)
            fi
            
            # åˆ›å»ºæ–°çš„è¡¨æ ¼å†…å®¹
            NEW_TABLE="## ğŸ“‹ åŒæ­¥æ—¥å¿—
            
| æ—¶é—´ | è§¦å‘æ–¹å¼ | é•œåƒID | å¤§å° | åŸå§‹åˆ›å»ºæ—¶é—´ | è¯¦ç»†æ—¥å¿— |
|------|--------|--------|------|------------|----------|
 ${{ steps.log-content.outputs.entry }}
"
            
            # ç»„åˆæ–°çš„READMEå†…å®¹
            NEW_README="$BEFORE_TABLE
 $NEW_TABLE
 $AFTER_TABLE"
          else
            echo "ğŸ“„ READMEä¸­ä¸å­˜åœ¨æ—¥å¿—è¡¨æ ¼ï¼Œå°†åˆ›å»º..."
            
            # åœ¨READMEæœ«å°¾æ·»åŠ æ—¥å¿—è¡¨æ ¼
            NEW_README="$README_CONTENT

## ğŸ“‹ åŒæ­¥æ—¥å¿—

| æ—¶é—´ | è§¦å‘æ–¹å¼ | é•œåƒID | å¤§å° | åŸå§‹åˆ›å»ºæ—¶é—´ | è¯¦ç»†æ—¥å¿— |
|------|--------|--------|------|------------|----------|
 ${{ steps.log-content.outputs.entry }}
"
          fi
          
          # å†™å…¥æ–°çš„READMEå†…å®¹
          echo "$NEW_README" > README.md
          
          echo "âœ… READMEæ–‡ä»¶å·²æ›´æ–°"

      - name: ğŸš€ æäº¤å¹¶æ¨é€æ›´æ”¹
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "ğŸ“ æ›´æ–°åŒæ­¥æ—¥å¿— - ${{ steps.log-content.outputs.trigger_type }} @ $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          
          echo "âœ… æ›´æ”¹å·²æäº¤å¹¶æ¨é€åˆ°ä»“åº“"

      - name: ğŸ“ è¾“å‡ºæœ€ç»ˆé•œåƒåœ°å€
        run: |
          echo "ğŸ‰ åŒæ­¥å®Œæˆï¼"
          echo "ğŸ“ é•œåƒåœ°å€: ghcr.io/${{ github.repository_owner }}/openai-new:latest"
          echo "ğŸ“… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ”— æŸ¥çœ‹è¯¦ç»†æ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
