# .github/workflows/sync-openai-new.yml
name: ğŸš€ è‡ªåŠ¨åŒæ­¥é•œåƒå¹¶æ›´æ–° README

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤© UTC 2 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ 10 ç‚¹ï¼‰

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: write  # å¿…éœ€ï¼šå…è®¸ push README åˆ°ä»“åº“

    steps:
      - name: ğŸ› ï¸ æ£€å‡ºå½“å‰ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ•’ è·å–å½“å‰æ—¶é—´ï¼ˆä¸­æ–‡å‹å¥½ï¼‰
        id: time
        run: |
          echo "now=$(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S %Z')" >> $GITHUB_OUTPUT
          echo "utc=$(date -u '+%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: ğŸ” ç™»å½• GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ æ‹‰å–æºé•œåƒ
        id: pull
        run: |
          echo "å¼€å§‹æ‹‰å– calciumion/new-api:latest..."
          docker pull calciumion/new-api:latest
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' calciumion/new-api:latest)
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "âœ… æ‹‰å–æˆåŠŸï¼é•œåƒæ‘˜è¦: $DIGEST"

      - name: ğŸ·ï¸ é‡å‘½åå¹¶æ¨é€
        id: push
        run: |
          echo "é‡å‘½åå¹¶æ¨é€è‡³ GHCR..."
          docker tag calciumion/new-api:latest ghcr.io/bqizkm01918t/openai-new:latest
          docker push ghcr.io/bqizkm01918t/openai-new:latest
          echo "âœ… æ¨é€å®Œæˆï¼"

      - name: ğŸ“ ç”Ÿæˆ README.md
        run: |
          cat > README.md << EOF
# ğŸ”„ é•œåƒè‡ªåŠ¨åŒæ­¥çŠ¶æ€

æœ¬ä»“åº“è‡ªåŠ¨å°† Docker Hub é•œåƒ **\`calciumion/new-api:latest\`** åŒæ­¥è‡³ GitHub Container Registryã€‚

---

## ğŸ“Œ æœ€æ–°åŒæ­¥ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **åŒæ­¥æ—¶é—´** | ${{ steps.time.outputs.now }} |
| **UTC æ—¶é—´** | ${{ steps.time.outputs.utc }} |
| **æºé•œåƒ** | \`docker.io/calciumion/new-api:latest\` |
| **ç›®æ ‡é•œåƒ** | \`ghcr.io/bqizkm01918t/openai-new:latest\` |
| **é•œåƒæ‘˜è¦ (Digest)** | \`${{ steps.pull.outputs.digest }}\` |
| **çŠ¶æ€** | âœ… **åŒæ­¥æˆåŠŸ** |

---

## ğŸ³ å¦‚ä½•ä½¿ç”¨ï¼Ÿ

ä½ å¯ä»¥ç›´æ¥æ‹‰å–é•œåƒï¼š

\`\`\`bash
docker pull ghcr.io/bqizkm01918t/openai-new:latest
\`\`\`

> ğŸ’¡ é•œåƒæ¯æ—¥è‡ªåŠ¨æ›´æ–°ã€‚å¦‚éœ€å…¬å¼€è®¿é—®ï¼Œè¯·ç¡®ä¿è¯¥åŒ…åœ¨ GitHub ä¸Šè®¾ä¸º **Public**ã€‚

---

## ğŸ“… è‡ªåŠ¨åŒæ­¥è®¡åˆ’

- **é¢‘ç‡**ï¼šæ¯å¤©ä¸€æ¬¡ï¼ˆUTC æ—¶é—´ 02:00ï¼ŒåŒ—äº¬æ—¶é—´ 10:00ï¼‰
- **è§¦å‘æ–¹å¼**ï¼šGitHub Actions å®šæ—¶ä»»åŠ¡
- **å·¥ä½œæµæ–‡ä»¶**ï¼š[\`.github/workflows/sync-openai-new.yml\`](.github/workflows/sync-openai-new.yml)

---

> ğŸ•’ æœ€åæ›´æ–°äºï¼š${{ steps.time.outputs.now }}

EOF

      - name: ğŸ“¤ æäº¤å¹¶æ¨é€ README æ›´æ–°
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add README.md
          git diff --quiet && git diff --staged --quiet || (git commit -m "ğŸ“ è‡ªåŠ¨æ›´æ–°åŒæ­¥çŠ¶æ€ [${{ steps.time.outputs.utc }}]" && git push)

      - name: âœ… å®Œæˆé€šçŸ¥
        run: echo "ğŸ‰ README å·²æ›´æ–°ï¼é•œåƒåŒæ­¥æˆåŠŸã€‚"
