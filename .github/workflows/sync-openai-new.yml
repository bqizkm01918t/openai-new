# .github/workflows/sync-openai-new.yml
name: ğŸš€ è‡ªåŠ¨åŒæ­¥é•œåƒå¹¶æ›´æ–° README

on:
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤© UTC 2 ç‚¹è‡ªåŠ¨æ‰§è¡Œ

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: write  # å…è®¸æ¨é€ README

    steps:
      - name: ğŸ› ï¸ æ£€å‡ºä»“åº“ä»£ç ï¼ˆç¡®ä¿ Actions ä¸Šä¸‹æ–‡æ­£ç¡®ï¼‰
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” è¯†åˆ«è§¦å‘æ–¹å¼
        id: trigger
        run: |
          EVENT="${{ github.event_name }}"
          if [ "$EVENT" == "schedule" ]; then
            echo "type=è‡ªåŠ¨å®šæ—¶æ‰§è¡Œ" >> $GITHUB_OUTPUT
            echo "icon=ğŸ•’" >> $GITHUB_OUTPUT
          elif [ "$EVENT" == "workflow_dispatch" ]; then
            echo "type=æ‰‹åŠ¨è§¦å‘" >> $GITHUB_OUTPUT
            echo "icon=ğŸ–±ï¸" >> $GITHUB_OUTPUT
          else
            echo "type=å…¶ä»–æ–¹å¼ ($EVENT)" >> $GITHUB_OUTPUT
            echo "icon=â“" >> $GITHUB_OUTPUT
          fi
          echo "event=$EVENT" >> $GITHUB_OUTPUT

      - name: ğŸ•’ è·å–å½“å‰æ—¶é—´
        id: time
        run: |
          echo "now=$(date '+%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S %Z')" >> $GITHUB_OUTPUT
          echo "utc=$(date -u '+%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

      - name: ğŸ” ç™»å½• GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ æ‹‰å–æºé•œåƒ (calciumion/new-api:latest)
        id: pull
        run: |
          echo "ğŸ“¥ æ­£åœ¨æ‹‰å–é•œåƒ: calciumion/new-api:latest"
          docker pull calciumion/new-api:latest
          DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' calciumion/new-api:latest 2>/dev/null || echo "N/A")
          echo "digest=$DIGEST" >> $GITHUB_OUTPUT
          echo "âœ… æ‹‰å–æˆåŠŸï¼é•œåƒæ‘˜è¦: $DIGEST"

      - name: ğŸ·ï¸ é‡å‘½åå¹¶æ¨é€åˆ° GHCR
        run: |
          echo "ğŸ”„ é‡å‘½åå¹¶æ¨é€è‡³ ghcr.io/bqizkm01918t/openai-new:latest"
          docker tag calciumion/new-api:latest ghcr.io/bqizkm01918t/openai-new:latest
          docker push ghcr.io/bqizkm01918t/openai-new:latest
          echo "ğŸ“¤ æ¨é€å®Œæˆï¼"

      - name: ğŸ“ ç”Ÿæˆè¯¦ç»†çš„ä¸­æ–‡ README.md
        run: |
          cat > README.md << EOF
# ğŸ”„ é•œåƒè‡ªåŠ¨åŒæ­¥çŠ¶æ€

æœ¬ä»“åº“è‡ªåŠ¨å°† Docker Hub é•œåƒ \`calciumion/new-api:latest\` åŒæ­¥è‡³ GitHub Container Registryï¼Œå¹¶é‡å‘½åä¸º \`openai-new\`ã€‚

---

## ğŸ“Œ æœ€æ–°åŒæ­¥ä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **è§¦å‘æ–¹å¼** | ${{ steps.trigger.outputs.icon }} **${{ steps.trigger.outputs.type }}** |
| **åŒæ­¥æ—¶é—´** | ${{ steps.time.outputs.now }} |
| **UTC æ—¶é—´** | ${{ steps.time.outputs.utc }} |
| **GitHub äº‹ä»¶ç±»å‹** | \`${{ steps.trigger.outputs.event }}\` |
| **æºé•œåƒ** | \`docker.io/calciumion/new-api:latest\` |
| **ç›®æ ‡é•œåƒ** | \`ghcr.io/bqizkm01918t/openai-new:latest\` |
| **é•œåƒæ‘˜è¦ (Digest)** | \`${{ steps.pull.outputs.digest }}\` |
| **çŠ¶æ€** | âœ… **åŒæ­¥æˆåŠŸ** |

---

## ğŸ³ ä½¿ç”¨æ–¹å¼

\`\`\`bash
# æ‹‰å–é•œåƒ
docker pull ghcr.io/bqizkm01918t/openai-new:latest
\`\`\`

> ğŸ’¡ é•œåƒæ¯æ—¥è‡ªåŠ¨æ›´æ–°ï¼ˆUTC 02:00ï¼‰ã€‚å¦‚éœ€å…¬å¼€è®¿é—®ï¼Œè¯·åœ¨ GitHub Packages ä¸­å°†è¯¥é•œåƒè®¾ä¸º **Public**ã€‚

---

## ğŸ“… è‡ªåŠ¨åŒæ­¥è®¡åˆ’

- **å®šæ—¶ä»»åŠ¡**ï¼šæ¯å¤©ä¸€æ¬¡ï¼ˆUTC 02:00ï¼ŒåŒ—äº¬æ—¶é—´ 10:00ï¼‰
- **å·¥ä½œæµæ–‡ä»¶**ï¼š[\`.github/workflows/sync-openai-new.yml\`](.github/workflows/sync-openai-new.yml)
- **ä»“åº“**ï¼š[${{ github.repository }}](https://github.com/${{ github.repository }})

---

> ğŸ•’ æœ¬é¡µé¢ç”± GitHub Actions è‡ªåŠ¨æ›´æ–°äºï¼š${{ steps.time.outputs.now }}

EOF

      - name: ğŸ“¤ æäº¤å¹¶æ¨é€ README
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          git add README.md
          # ä»…å½“ README æœ‰å˜åŒ–æ—¶æ‰æäº¤
          if ! git diff --quiet HEAD -- README.md; then
            git commit -m "ğŸ“ è‡ªåŠ¨æ›´æ–°é•œåƒçŠ¶æ€ [${{ steps.trigger.outputs.type }} @ ${{ steps.time.outputs.utc }}]"
            git push
            echo "âœ… README å·²æ¨é€æ›´æ–°ã€‚"
          else
            echo "â„¹ï¸ README æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤ã€‚"
          fi

      - name: âœ… å®Œæˆ
        run: echo "ğŸ‰ åŒæ­¥ä¸æ–‡æ¡£æ›´æ–°å…¨éƒ¨å®Œæˆï¼"
