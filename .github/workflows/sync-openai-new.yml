# .github/workflows/sync-openai-new.yml
name: ğŸš€ è‡ªåŠ¨åŒæ­¥ calciumion/new-api åˆ° GHCR

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨ 2 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ä¸Šåˆ 10 ç‚¹ï¼‰è‡ªåŠ¨åŒæ­¥

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      packages: write  # å¿…éœ€ï¼šå…è®¸æ¨é€é•œåƒåˆ° GHCR

    steps:
      - name: ğŸ› ï¸ å‡†å¤‡ç¯å¢ƒ
        run: |
          echo "âœ… å¼€å§‹åŒæ­¥æµç¨‹..."
          echo "â° å½“å‰æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"

      - name: ğŸ” ç™»å½•åˆ° GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        id: login
        continue-on-error: false

      - name: ğŸ“¦ æ‹‰å– Docker Hub ä¸Šçš„æœ€æ–°é•œåƒ
        run: |
          echo "ğŸ“¦ æ­£åœ¨æ‹‰å–: calciumion/new-api:latest"
          docker pull calciumion/new-api:latest
          echo "âœ… æ‹‰å–æˆåŠŸï¼"

      - name: ğŸ·ï¸ é‡å‘½åé•œåƒä¸º openai-new
        run: |
          echo "ğŸ”„ é‡å‘½åé•œåƒ: calciumion/new-api -> ghcr.io/bqizkm01918t/openai-new"
          docker tag calciumion/new-api:latest ghcr.io/bqizkm01918t/openai-new:latest
          echo "âœ… é‡å‘½åå®Œæˆï¼"

      - name: ğŸš€ æ¨é€é•œåƒåˆ° GHCR
        run: |
          echo "ğŸ“¤ æ­£åœ¨æ¨é€: ghcr.io/bqizkm01918t/openai-new:latest"
          docker push ghcr.io/bqizkm01918t/openai-new:latest
          echo "âœ… æ¨é€å®Œæˆï¼é•œåƒå·²è¦†ç›–æ›´æ–°ã€‚"

      - name: ğŸ§ª éªŒè¯é•œåƒæ˜¯å¦æ¨é€æˆåŠŸ
        run: |
          echo "ğŸ” éªŒè¯é•œåƒæ˜¯å¦å­˜åœ¨..."
          docker images | grep -E 'bqizkm01918t/openai-new'
          if [ $? -eq 0 ]; then
            echo "âœ… éªŒè¯é€šè¿‡ï¼šé•œåƒå·²å­˜åœ¨æœ¬åœ°ç¼“å­˜ä¸­ã€‚"
          else
            echo "âŒ éªŒè¯å¤±è´¥ï¼šé•œåƒæœªæ‰¾åˆ°ï¼"
            exit 1
          fi

      - name: ğŸ“ è¾“å‡ºæœ€ç»ˆé•œåƒåœ°å€
        run: |
          echo "ğŸ‰ åŒæ­¥å®Œæˆï¼"
          echo "ğŸ“ é•œåƒåœ°å€: ghcr.io/bqizkm01918t/openai-new:latest"
          echo "ğŸ“… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
