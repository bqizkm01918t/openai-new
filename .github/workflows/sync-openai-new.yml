name: ğŸš€ è‡ªåŠ¨åŒæ­¥ calciumion/new-api åˆ° GHCR

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨ 2 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ä¸Šåˆ 10 ç‚¹ï¼‰è‡ªåŠ¨åŒæ­¥

env:
  MAX_TAGS: 20  # æœ€å¤šä¿ç•™çš„æ ‡ç­¾æ•°é‡

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      packages: write  # å¿…éœ€ï¼šå…è®¸æ¨é€é•œåƒåˆ° GHCR
      contents: write  # å¿…éœ€ï¼šå…è®¸æ›´æ–°READMEæ–‡ä»¶

    steps:
      - name: ğŸ› ï¸ å‡†å¤‡ç¯å¢ƒ
        run: |
          echo "âœ… å¼€å§‹åŒæ­¥æµç¨‹..."
          echo "â° å½“å‰æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          # åˆ¤æ–­è§¦å‘æ–¹å¼
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "TRIGGER_TYPE=æ‰‹åŠ¨è§¦å‘" >> $GITHUB_ENV
          else
            echo "TRIGGER_TYPE=è‡ªåŠ¨æ‰§è¡Œ" >> $GITHUB_ENV
          fi

      - name: ğŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” ç™»å½•åˆ° GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        id: login
        continue-on-error: false

      - name: ğŸ—‘ï¸ æ¸…ç†æœ¬åœ°ç¼“å­˜
        run: |
          echo "ğŸ—‘ï¸ æ¸…ç†æœ¬åœ°Dockerç¼“å­˜ä»¥ç¡®ä¿è·å–æœ€æ–°é•œåƒ..."
          docker system prune -af
          docker rmi ghcr.io/bqizkm01918t/openai-new:latest 2>/dev/null || true
          docker rmi calciumion/new-api:latest 2>/dev/null || true
          echo "âœ… æ¸…ç†å®Œæˆ"

      - name: ğŸ“¦ å¼ºåˆ¶æ‹‰å– Docker Hub ä¸Šçš„æœ€æ–°é•œåƒ
        run: |
          echo "ğŸ“¦ æ­£åœ¨å¼ºåˆ¶æ‹‰å–æœ€æ–°é•œåƒ: calciumion/new-api:latest"
          docker pull calciumion/new-api:latest
          echo "âœ… æ‹‰å–æˆåŠŸï¼"
          
          # è·å–æºé•œåƒçš„æ‘˜è¦ä¿¡æ¯ç”¨äºéªŒè¯
          SOURCE_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' calciumion/new-api:latest)
          echo "æºé•œåƒæ‘˜è¦: $SOURCE_DIGEST"
          echo "SOURCE_DIGEST=$SOURCE_DIGEST" >> $GITHUB_ENV

      - name: ğŸ”„ è®¡ç®—å¾ªç¯æ ‡ç­¾
        id: calculate_tag
        run: |
          # è¯»å–æˆ–åˆ›å»ºæ ‡ç­¾ç´¢å¼•æ–‡ä»¶
          if [ -f ".tag_index" ]; then
            CURRENT_INDEX=$(cat .tag_index)
          else
            CURRENT_INDEX=0
          fi
          
          # è®¡ç®—ä¸‹ä¸€ä¸ªç´¢å¼•ï¼ˆ0-19å¾ªç¯ï¼‰
          NEXT_INDEX=$(( (CURRENT_INDEX + 1) % ${{ env.MAX_TAGS }} ))
          
          # ç”Ÿæˆæ ‡ç­¾åç§°ï¼ˆv0 åˆ° v19ï¼‰
          TAG_NAME="v${NEXT_INDEX}"
          
          # ç”Ÿæˆæ—¶é—´æˆ³ï¼ˆç”¨äºè®°å½•ï¼‰
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          READABLE_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          
          # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
          echo "TAG_INDEX=$NEXT_INDEX" >> $GITHUB_ENV
          echo "TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV
          echo "READABLE_TIME=$READABLE_TIME" >> $GITHUB_ENV
          
          # æ›´æ–°ç´¢å¼•æ–‡ä»¶
          echo "$NEXT_INDEX" > .tag_index
          
          echo "ğŸ“ å°†ä½¿ç”¨æ ‡ç­¾: $TAG_NAME (ç´¢å¼•: $NEXT_INDEX)"
          echo "ğŸ“… æ—¶é—´æˆ³: $TIMESTAMP"

      - name: ğŸ·ï¸ é‡å‘½åé•œåƒä¸º openai-new
        run: |
          echo "ğŸ”„ é‡å‘½åé•œåƒ: calciumion/new-api -> ghcr.io/bqizkm01918t/openai-new"
          # åˆ›å»ºå¾ªç¯æ ‡ç­¾
          docker tag calciumion/new-api:latest ghcr.io/bqizkm01918t/openai-new:${{ env.TAG_NAME }}
          # åŒæ—¶æ›´æ–°latestæ ‡ç­¾
          docker tag calciumion/new-api:latest ghcr.io/bqizkm01918t/openai-new:latest
          echo "âœ… é‡å‘½åå®Œæˆï¼ä½¿ç”¨æ ‡ç­¾: ${{ env.TAG_NAME }}"

      - name: ğŸš€ æ¨é€é•œåƒåˆ° GHCR
        run: |
          echo "ğŸ“¤ æ­£åœ¨æ¨é€ç‰ˆæœ¬æ ‡ç­¾: ghcr.io/bqizkm01918t/openai-new:${{ env.TAG_NAME }}"
          docker push ghcr.io/bqizkm01918t/openai-new:${{ env.TAG_NAME }}
          
          echo "ğŸ“¤ æ­£åœ¨æ¨é€latestæ ‡ç­¾: ghcr.io/bqizkm01918t/openai-new:latest"
          docker push ghcr.io/bqizkm01918t/openai-new:latest
          
          echo "âœ… æ¨é€å®Œæˆï¼é•œåƒå·²æ›´æ–°ã€‚"

      - name: ğŸ“‹ æ›´æ–°ç‰ˆæœ¬å†å²è®°å½•
        run: |
          # åˆ›å»ºæˆ–æ›´æ–°ç‰ˆæœ¬å†å²æ–‡ä»¶
          HISTORY_FILE="version_history.json"
          
          # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ªç©ºçš„JSONæ•°ç»„
          if [ ! -f "$HISTORY_FILE" ]; then
            echo "[]" > $HISTORY_FILE
          fi
          
          # è¯»å–ç°æœ‰å†å²
          HISTORY=$(cat $HISTORY_FILE)
          
          # æ·»åŠ æ–°è®°å½•
          NEW_ENTRY=$(cat <<EOF
          {
            "tag": "${{ env.TAG_NAME }}",
            "timestamp": "${{ env.TIMESTAMP }}",
            "readable_time": "${{ env.READABLE_TIME }}",
            "source_digest": "${{ env.SOURCE_DIGEST }}",
            "trigger_type": "${{ env.TRIGGER_TYPE }}"
          }
          EOF
          )
          
          # ä½¿ç”¨jqæ›´æ–°å†å²ï¼ˆä¿ç•™æœ€æ–°20æ¡è®°å½•ï¼‰
          echo "$HISTORY" | jq --argjson new "$NEW_ENTRY" '. |= ([$new] + . | .[0:20])' > $HISTORY_FILE
          
          echo "âœ… ç‰ˆæœ¬å†å²å·²æ›´æ–°"

      - name: ğŸ§ª éªŒè¯é•œåƒæ˜¯å¦æ¨é€æˆåŠŸ
        run: |
          echo "ğŸ” éªŒè¯é•œåƒæ˜¯å¦æˆåŠŸæ¨é€åˆ°GHCR..."
          
          # æ¸…é™¤æœ¬åœ°ç¼“å­˜ï¼Œç„¶åä»GHCRæ‹‰å–é•œåƒè¿›è¡ŒéªŒè¯
          docker rmi ghcr.io/bqizkm01918t/openai-new:latest 2>/dev/null || true
          docker rmi ghcr.io/bqizkm01918t/openai-new:${{ env.TAG_NAME }} 2>/dev/null || true
          
          docker pull ghcr.io/bqizkm01918t/openai-new:latest
          docker pull ghcr.io/bqizkm01918t/openai-new:${{ env.TAG_NAME }}
          
          # è·å–æ¨é€åé•œåƒçš„æ‘˜è¦ä¿¡æ¯
          PUSHED_DIGEST=$(docker inspect --format='{{index .RepoDigests 0}}' ghcr.io/bqizkm01918t/openai-new:latest)
          echo "æ¨é€åé•œåƒæ‘˜è¦: $PUSHED_DIGEST"
          
          # éªŒè¯é•œåƒæ˜¯å¦å­˜åœ¨
          docker images | grep -E 'bqizkm01918t/openai-new'
          if [ $? -eq 0 ]; then
            echo "âœ… éªŒè¯é€šè¿‡ï¼šé•œåƒå·²æˆåŠŸæ¨é€åˆ°GHCRå¹¶å¯ä»¥æ‹‰å–ã€‚"
          else
            echo "âŒ éªŒè¯å¤±è´¥ï¼šé•œåƒæœªæ‰¾åˆ°ï¼"
            exit 1
          fi

      - name: ğŸ“ è·å–é•œåƒä¿¡æ¯
        id: image_info
        run: |
          # è·å–é•œåƒå¤§å°
          IMAGE_SIZE=$(docker images --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}" | grep "ghcr.io/bqizkm01918t/openai-new:latest" | awk '{print $2}')
          echo "IMAGE_SIZE=$IMAGE_SIZE" >> $GITHUB_ENV
          
          # è·å–é•œåƒåˆ›å»ºæ—¶é—´
          IMAGE_CREATED=$(docker images --format "table {{.Repository}}:{{.Tag}}\t{{.CreatedAt}}" | grep "ghcr.io/bqizkm01918t/openai-new:latest" | awk '{print $2" "$3" "$4" "$5}')
          echo "IMAGE_CREATED=$IMAGE_CREATED" >> $GITHUB_ENV
          
          # è·å–å½“å‰æ—¥æœŸ
          CURRENT_DATE=$(date '+%Y-%m-%d %H:%M:%S %Z')
          echo "CURRENT_DATE=$CURRENT_DATE" >> $GITHUB_ENV

      - name: ğŸ“Š ç”Ÿæˆç‰ˆæœ¬å†å²è¡¨æ ¼
        id: generate_history
        run: |
          # è¯»å–ç‰ˆæœ¬å†å²å¹¶ç”ŸæˆMarkdownè¡¨æ ¼
          if [ -f "version_history.json" ]; then
            # ç”Ÿæˆæœ€è¿‘10æ¡è®°å½•çš„è¡¨æ ¼
            HISTORY_TABLE=$(cat version_history.json | jq -r '
              .[:10] | 
              map("| " + .readable_time + " | " + .tag + " | " + .trigger_type + " | âœ… |") | 
              join("\n")
            ')
            
            # è·å–æ‰€æœ‰å¯ç”¨æ ‡ç­¾åˆ—è¡¨
            AVAILABLE_TAGS=$(cat version_history.json | jq -r '
              [.[] | .tag] | unique | join(", ")
            ')
            
            echo "HISTORY_TABLE<<EOF" >> $GITHUB_ENV
            echo "$HISTORY_TABLE" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
            
            echo "AVAILABLE_TAGS=$AVAILABLE_TAGS" >> $GITHUB_ENV
          else
            echo "HISTORY_TABLE=| æš‚æ— è®°å½• | - | - | - |" >> $GITHUB_ENV
            echo "AVAILABLE_TAGS=${{ env.TAG_NAME }}" >> $GITHUB_ENV
          fi

      - name: ğŸ“„ æ›´æ–° README
        run: |
          # åˆ›å»ºæ–°çš„READMEå†…å®¹
          cat > README.md << 'EOF'
          # OpenAI-New API é•œåƒåŒæ­¥ä»“åº“
          
          ## ğŸ“‹ é¡¹ç›®ç®€ä»‹
          
          æœ¬ä»“åº“è‡ªåŠ¨åŒæ­¥ [calciumion/new-api](https://hub.docker.com/r/calciumion/new-api) Docker é•œåƒåˆ° GitHub Container Registry (GHCR)ã€‚
          
          ## ğŸš€ é•œåƒä¿¡æ¯
          
          - **é•œåƒåœ°å€**: `ghcr.io/bqizkm01918t/openai-new:latest`
          - **é•œåƒå¤§å°**: ${{ env.IMAGE_SIZE }}
          - **æºé•œåƒ**: `calciumion/new-api:latest`
          - **åŒæ­¥é¢‘ç‡**: æ¯æ—¥è‡ªåŠ¨åŒæ­¥ (åŒ—äº¬æ—¶é—´ä¸Šåˆ 10 ç‚¹)
          - **å½“å‰ç‰ˆæœ¬**: ${{ env.TAG_NAME }}
          - **ç‰ˆæœ¬ç­–ç•¥**: å¾ªç¯ä½¿ç”¨ v0-v19 å…±20ä¸ªæ ‡ç­¾
          
          ## ğŸ“… æœ€è¿‘åŒæ­¥è®°å½• (æœ€æ–°10æ¡)
          
          | åŒæ­¥æ—¶é—´ | ç‰ˆæœ¬æ ‡ç­¾ | è§¦å‘æ–¹å¼ | çŠ¶æ€ |
          |----------|----------|----------|------|
          ${{ env.HISTORY_TABLE }}
          
          ## ğŸ·ï¸ å¯ç”¨ç‰ˆæœ¬æ ‡ç­¾
          
          - **æœ€æ–°ç‰ˆæœ¬**: `latest` (å§‹ç»ˆæŒ‡å‘æœ€æ–°ç‰ˆæœ¬)
          - **å†å²ç‰ˆæœ¬**: ${{ env.AVAILABLE_TAGS }}
          
          > âš ï¸ æ³¨æ„ï¼šç³»ç»Ÿè‡ªåŠ¨å¾ªç¯ä½¿ç”¨ v0-v19 å…±20ä¸ªæ ‡ç­¾ï¼Œæ—§ç‰ˆæœ¬ä¼šè¢«æ–°ç‰ˆæœ¬è¦†ç›–ã€‚
          
          ## ğŸ”„ ç‰ˆæœ¬ç®¡ç†ç­–ç•¥
          
          1. ä½¿ç”¨ **å¾ªç¯æ ‡ç­¾ç³»ç»Ÿ** (v0 â†’ v19 â†’ v0)
          2. è‡ªåŠ¨è¦†ç›–æœ€è€çš„æ ‡ç­¾
          3. å§‹ç»ˆä¿ç•™æœ€è¿‘20ä¸ªç‰ˆæœ¬
          4. `latest` æ ‡ç­¾å§‹ç»ˆæŒ‡å‘æœ€æ–°ç‰ˆæœ¬
          
          ## ğŸ“¦ ä½¿ç”¨æ–¹æ³•
          
          ### ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬
          
          ```bash
          # ä½¿ç”¨latestæ ‡ç­¾ï¼ˆæ¨èï¼‰
          docker run --name new-api -d --restart always \
            -p 3000:3000 \
            -e TZ=Asia/Shanghai \
            -v /home/ubuntu/data/new-api:/data \
            ghcr.io/bqizkm01918t/openai-new:latest
          ```
          
          ### ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬
          
          ```bash
          # ä½¿ç”¨ç‰¹å®šç‰ˆæœ¬æ ‡ç­¾
          docker run --name new-api -d --restart always \
            -p 3000:3000 \
            -e TZ=Asia/Shanghai \
            -v /home/ubuntu/data/new-api:/data \
            ghcr.io/bqizkm01918t/openai-new:${{ env.TAG_NAME }}
          ```
          
          ### Docker Compose
          
          ```yaml
          version: '3'
          services:
            openai-new:
              image: ghcr.io/bqizkm01918t/openai-new:latest
              container_name: new-api
              restart: always
              ports:
                - "3000:3000"
              environment:
                - TZ=Asia/Shanghai
              volumes:
                - /home/ubuntu/data/new-api:/data
          ```
          
          ## âš™ï¸ é…ç½®è¯´æ˜
          
          - **ç«¯å£æ˜ å°„**: å®¹å™¨å†… 3000 ç«¯å£æ˜ å°„åˆ°ä¸»æœº 3000 ç«¯å£
          - **æ—¶åŒºè®¾ç½®**: è®¾ç½®ä¸ºäºšæ´²/ä¸Šæµ·æ—¶åŒº
          - **æ•°æ®æŒä¹…åŒ–**: ä¸»æœºç›®å½• `/home/ubuntu/data/new-api` æŒ‚è½½åˆ°å®¹å™¨å†… `/data` ç›®å½•
          - **è‡ªåŠ¨é‡å¯**: å®¹å™¨å¼‚å¸¸é€€å‡ºæ—¶è‡ªåŠ¨é‡å¯
          
          ## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯
          
          - **æœ€ååŒæ­¥æ—¶é—´**: ${{ env.CURRENT_DATE }}
          - **å½“å‰ç‰ˆæœ¬æ ‡ç­¾**: ${{ env.TAG_NAME }}
          - **åŒæ­¥è§¦å‘æ–¹å¼**: ${{ env.TRIGGER_TYPE }}
          - **åŒæ­¥çŠ¶æ€**: âœ… æˆåŠŸ
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          
          - æœ¬é•œåƒä»…ä½œåŒæ­¥ç”¨é€”ï¼Œè¯·å‹¿ç”¨äºç”Ÿäº§ç¯å¢ƒ
          - ç‰ˆæœ¬æ ‡ç­¾å¾ªç¯ä½¿ç”¨ï¼Œè¶…è¿‡20ä¸ªç‰ˆæœ¬åä¼šè¦†ç›–æ—§ç‰ˆæœ¬
          - å¦‚éœ€é•¿æœŸä¿å­˜ç‰¹å®šç‰ˆæœ¬ï¼Œè¯·è‡ªè¡Œå¤‡ä»½
          - é•œåƒæ¯æ—¥è‡ªåŠ¨åŒæ­¥ï¼Œå¯èƒ½å­˜åœ¨å»¶è¿Ÿ
          
          ---
          
          *æ­¤ README ç”± GitHub Actions è‡ªåŠ¨æ›´æ–°äº ${{ env.CURRENT_DATE }}*
          EOF
          
          echo "âœ… README å·²æ›´æ–°"

      - name: ğŸ”€ æäº¤å¹¶æ¨é€æ›´æ”¹
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ·»åŠ æ‰€æœ‰æ›´æ”¹çš„æ–‡ä»¶
          git add README.md
          git add .tag_index
          git add version_history.json 2>/dev/null || true
          
          # æäº¤æ›´æ”¹
          git commit -m "ğŸ”„ è‡ªåŠ¨åŒæ­¥ #${{ env.TAG_INDEX }} - ${{ env.TAG_NAME }} - ${{ env.TRIGGER_TYPE }} - ${{ env.CURRENT_DATE }}"
          git push

      - name: ğŸ“ è¾“å‡ºæœ€ç»ˆé•œåƒåœ°å€
        run: |
          echo "ğŸ‰ åŒæ­¥å®Œæˆï¼"
          echo "ğŸ“ é•œåƒåœ°å€: ghcr.io/bqizkm01918t/openai-new:latest"
          echo "ğŸ“ ç‰ˆæœ¬é•œåƒ: ghcr.io/bqizkm01918t/openai-new:${{ env.TAG_NAME }}"
          echo "ğŸ”¢ æ ‡ç­¾ç´¢å¼•: ${{ env.TAG_INDEX }}/19"
          echo "ğŸ“… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ğŸ”„ è§¦å‘æ–¹å¼: ${{ env.TRIGGER_TYPE }}"
          echo ""
          echo "ğŸ“Œ ç‰ˆæœ¬ç®¡ç†ä¿¡æ¯ï¼š"
          echo "   - å½“å‰ä½¿ç”¨æ ‡ç­¾: ${{ env.TAG_NAME }}"
          echo "   - ä¸‹æ¬¡å°†ä½¿ç”¨: v$(( (${{ env.TAG_INDEX }} + 1) % 20 ))"
          echo "   - å·²å¾ªç¯ä½¿ç”¨æ‰€æœ‰20ä¸ªæ ‡ç­¾ä½ç½®"
