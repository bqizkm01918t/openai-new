name: ðŸš€ è‡ªåŠ¨åŒæ­¥ calciumion/new-api åˆ° GHCR

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 2 * * *'  # æ¯å¤©å‡Œæ™¨ 2 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ä¸Šåˆ 10 ç‚¹ï¼‰è‡ªåŠ¨åŒæ­¥

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      packages: write  # å¿…éœ€ï¼šå…è®¸æŽ¨é€é•œåƒåˆ° GHCR
      contents: write  # å¿…éœ€ï¼šå…è®¸æ›´æ–°READMEæ–‡ä»¶

    steps:
      - name: ðŸ› ï¸ å‡†å¤‡çŽ¯å¢ƒ
        run: |
          echo "âœ… å¼€å§‹åŒæ­¥æµç¨‹..."
          echo "â° å½“å‰æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          # åˆ¤æ–­è§¦å‘æ–¹å¼
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "TRIGGER_TYPE=æ‰‹åŠ¨è§¦å‘" >> $GITHUB_ENV
          else
            echo "TRIGGER_TYPE=è‡ªåŠ¨æ‰§è¡Œ" >> $GITHUB_ENV
          fi

      - name: ðŸ“¥ æ£€å‡ºä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ” ç™»å½•åˆ° GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        id: login
        continue-on-error: false

      - name: ðŸ“¦ æ‹‰å– Docker Hub ä¸Šçš„æœ€æ–°é•œåƒ
        run: |
          echo "ðŸ“¦ æ­£åœ¨æ‹‰å–: calciumion/new-api:latest"
          docker pull calciumion/new-api:latest
          echo "âœ… æ‹‰å–æˆåŠŸï¼"

      - name: ðŸ·ï¸ é‡å‘½åé•œåƒä¸º openai-new
        run: |
          echo "ðŸ”„ é‡å‘½åé•œåƒ: calciumion/new-api -> ghcr.io/bqizkm01918t/openai-new"
          docker tag calciumion/new-api:latest ghcr.io/bqizkm01918t/openai-new:latest
          echo "âœ… é‡å‘½åå®Œæˆï¼"

      - name: ðŸš€ æŽ¨é€é•œåƒåˆ° GHCR
        run: |
          echo "ðŸ“¤ æ­£åœ¨æŽ¨é€: ghcr.io/bqizkm01918t/openai-new:latest"
          docker push ghcr.io/bqizkm01918t/openai-new:latest
          echo "âœ… æŽ¨é€å®Œæˆï¼é•œåƒå·²è¦†ç›–æ›´æ–°ã€‚"

      - name: ðŸ§ª éªŒè¯é•œåƒæ˜¯å¦æŽ¨é€æˆåŠŸ
        run: |
          echo "ðŸ” éªŒè¯é•œåƒæ˜¯å¦å­˜åœ¨..."
          docker images | grep -E 'bqizkm01918t/openai-new'
          if [ $? -eq 0 ]; then
            echo "âœ… éªŒè¯é€šè¿‡ï¼šé•œåƒå·²å­˜åœ¨æœ¬åœ°ç¼“å­˜ä¸­ã€‚"
          else
            echo "âŒ éªŒè¯å¤±è´¥ï¼šé•œåƒæœªæ‰¾åˆ°ï¼"
            exit 1
          fi

      - name: ðŸ“ èŽ·å–é•œåƒä¿¡æ¯
        id: image_info
        run: |
          # èŽ·å–é•œåƒå¤§å°
          IMAGE_SIZE=$(docker images --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}" | grep "ghcr.io/bqizkm01918t/openai-new:latest" | awk '{print $2}')
          echo "IMAGE_SIZE=$IMAGE_SIZE" >> $GITHUB_ENV
          
          # èŽ·å–é•œåƒåˆ›å»ºæ—¶é—´
          IMAGE_CREATED=$(docker images --format "table {{.Repository}}:{{.Tag}}\t{{.CreatedAt}}" | grep "ghcr.io/bqizkm01918t/openai-new:latest" | awk '{print $2" "$3" "$4" "$5}')
          echo "IMAGE_CREATED=$IMAGE_CREATED" >> $GITHUB_ENV
          
          # èŽ·å–å½“å‰æ—¥æœŸ
          CURRENT_DATE=$(date '+%Y-%m-%d %H:%M:%S %Z')
          echo "CURRENT_DATE=$CURRENT_DATE" >> $GITHUB_ENV

      - name: ðŸ“„ æ›´æ–° README
        run: |
          # åˆ›å»ºæ–°çš„READMEå†…å®¹
          cat > README.md << EOF
          # OpenAI-New API é•œåƒåŒæ­¥ä»“åº“
          
          ## ðŸ“‹ é¡¹ç›®ç®€ä»‹
          
          æœ¬ä»“åº“è‡ªåŠ¨åŒæ­¥ [calciumion/new-api](https://hub.docker.com/r/calciumion/new-api) Docker é•œåƒåˆ° GitHub Container Registry (GHCR)ã€‚
          
          ## ðŸš€ é•œåƒä¿¡æ¯
          
          - **é•œåƒåœ°å€**: \`ghcr.io/bqizkm01918t/openai-new:latest\`
          - **é•œåƒå¤§å°**: ${{ env.IMAGE_SIZE }}
          - **æºé•œåƒ**: \`calciumion/new-api:latest\`
          - **åŒæ­¥é¢‘çŽ‡**: æ¯æ—¥è‡ªåŠ¨åŒæ­¥ (åŒ—äº¬æ—¶é—´ä¸Šåˆ 10 ç‚¹)
          
          ## ðŸ“… åŒæ­¥è®°å½•
          
          | åŒæ­¥æ—¶é—´ | è§¦å‘æ–¹å¼ | çŠ¶æ€ |
          |----------|----------|------|
          | ${{ env.CURRENT_DATE }} | ${{ env.TRIGGER_TYPE }} | âœ… æˆåŠŸ |
          
          ## ðŸ”„ åŒæ­¥æµç¨‹
          
          1. ä»Ž Docker Hub æ‹‰å–æœ€æ–° \`calciumion/new-api\` é•œåƒ
          2. é‡æ–°æ ‡è®°ä¸º \`ghcr.io/bqizkm01918t/openai-new\`
          3. æŽ¨é€åˆ° GitHub Container Registry
          4. æ›´æ–°æœ¬ README æ–‡ä»¶
          
          ## ðŸ“¦ ä½¿ç”¨æ–¹æ³•
          
          ### Docker å‘½ä»¤
          
          \`\`\`bash
          docker pull ghcr.io/bqizkm01918t/openai-new:latest
          docker run -d --name openai-new -p 3000:3000 ghcr.io/bqizkm01918t/openai-new:latest
          \`\`\`
          
          ### Docker Compose
          
          \`\`\`yaml
          version: '3'
          services:
            openai-new:
              image: ghcr.io/bqizkm01918t/openai-new:latest
              container_name: openai-new
              ports:
                - "3000:3000"
              restart: unless-stopped
          \`\`\`
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          
          - æœ¬é•œåƒä»…ä½œåŒæ­¥ç”¨é€”ï¼Œè¯·å‹¿ç”¨äºŽç”Ÿäº§çŽ¯å¢ƒ
          - å¦‚éœ€äº†è§£åŽŸå§‹é¡¹ç›®è¯¦æƒ…ï¼Œè¯·è®¿é—® [calciumion/new-api](https://hub.docker.com/r/calciumion/new-api)
          - é•œåƒæ¯æ—¥è‡ªåŠ¨åŒæ­¥ï¼Œå¯èƒ½å­˜åœ¨å»¶è¿Ÿ
          
          ## ðŸ“Š ç»Ÿè®¡ä¿¡æ¯
          
          - **æœ€åŽåŒæ­¥æ—¶é—´**: ${{ env.IMAGE_CREATED }}
          - **åŒæ­¥è§¦å‘æ–¹å¼**: ${{ env.TRIGGER_TYPE }}
          - **åŒæ­¥çŠ¶æ€**: æˆåŠŸ
          
          ---
          
          *æ­¤ README ç”± GitHub Actions è‡ªåŠ¨æ›´æ–°*
          EOF
          
          echo "âœ… README å·²æ›´æ–°"

      - name: ðŸ”€ æäº¤å¹¶æŽ¨é€æ›´æ”¹
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "ðŸ“ è‡ªåŠ¨æ›´æ–° README - ${{ env.TRIGGER_TYPE }} - ${{ env.CURRENT_DATE }}"
          git push

      - name: ðŸ“ è¾“å‡ºæœ€ç»ˆé•œåƒåœ°å€
        run: |
          echo "ðŸŽ‰ åŒæ­¥å®Œæˆï¼"
          echo "ðŸ“ é•œåƒåœ°å€: ghcr.io/bqizkm01918t/openai-new:latest"
          echo "ðŸ“… å®Œæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S %Z')"
          echo "ðŸ”„ è§¦å‘æ–¹å¼: ${{ env.TRIGGER_TYPE }}"
